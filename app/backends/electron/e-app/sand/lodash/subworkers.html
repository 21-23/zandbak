<!DOCTYPE html>
<html>
<head>
    <script>
        (function() {
            var ipcRenderer = require('electron').ipcRenderer;
            var subworkerCounter = 0;
            var subworkers = {};

            function onSubworkerMessage(event, subworkerId) {
                var data = event.data;

                switch(data.type) {
                    case 'wrk::created':
                        return ipcRenderer.send('wrk::created', {
                            path: [subworkerId].concat(data.payload.path)
                        });
                    case 'wrk::filled':
                        return ipcRenderer.send('wrk::filled', {
                            path: [subworkerId].concat(data.payload.path),
                            fillerId: data.payload.fillerId
                        });
                    case 'wrk::done':
                        data.payload.path = [subworkerId].concat(data.payload.path)
                        return ipcRenderer.send('wrk::done', data.payload);
                }
            }

            function createSubworker(subworkerId) {
                var subworker = new Worker('worker.js');

                subworkers[subworkerId] = subworker;
                subworker.addEventListener('message', function (event) {
                    onSubworkerMessage(event, subworkerId);
                });

                subworker.postMessage({
                    type: 'wrk:>init',
                    payload: {
                        path: [subworkerId]
                    }
                });
            }

            ipcRenderer.on('wrk:>init', function (event, message) {
                for (var counter = 0; counter < message.subworkersCount; counter++) {
                    createSubworker(++subworkerCounter);
                }
            });

            ipcRenderer.on('wrk:>fill', function (event, message) {
                var subworkerId = message.path.shift();
                var subworker = subworkers[subworkerId];

                subworker.postMessage({
                    type: 'wrk:>fill',
                    payload: {
                        path: message.path,
                        fillerId: message.fillerId,
                        content: message.content
                    }
                });
            });

            ipcRenderer.on('wrk:>exec', function (event, message) {
                var subworkerId = message.path.shift();
                var subworker = subworkers[subworkerId];

                subworker.postMessage({
                    type: 'wrk:>exec',
                    payload: message
                });
            });

            ipcRenderer.on('wrk:>reload', function (event, message) {
                var subworkerId = message.path.shift();
                var subworker = subworkers[subworkerId];

                if (message.path.length !== 0) {
                    return subworker.postMessage({
                        type: 'wrk:>reload',
                        payload: {
                            path: message.path,
                        }
                    });
                }

                subworker.terminate();
                subworkers[subworkerId] = undefined;

                // create new subworker
                createSubworker(subworkerId);
            });
        })();
    </script>
</head>
<body>
</body>
</html>
